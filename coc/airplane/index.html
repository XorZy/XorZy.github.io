<!DOCTYPE html>
<html>

<head>
	<title>Air traffic control</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">

</head>

<body>

	<h1 style="text-align: center;">Air traffic control</h1>


	<img src="pU.png" id="planeUp" style="display:none" />
	<img src="pL.png" id="planeLeft"  style="display:none"/>
	<img src="pD.png" id="planeDown"  style="display:none" />
	<img src="pR.png" id="planeRight"  style="display:none" />
	<img src="collision.png" id="collision"  style="display:none" />

	<canvas id="buffer" width="128" height="128"  style="display:none"></canvas>
	<div class="container-fluid">
		<div class="row">
			<div class="col-md-12">
				<div class="jumbotron">
					<div id="container"></div>
				</div>
			</div>
		</div>
	</div>

	
	


	<script src="lodash.min.js"></script>

	<script>

		var bufferCanvas=document.getElementById("buffer");
		var bufferCtx=bufferCanvas.getContext("2d");

		function populate(data, element) {


			var header=document.createElement("h1");
			header.innerText=data[0];
			
			var txtLocation = document.createElement("p");
			
			var txtCollisions = document.createElement("p");
			txtCollisions.innerText="Collisions: 0";
		
			
			var txtTurn = document.createElement("p");
			txtTurn.innerText="Turn: 0";


			var canvas = document.createElement("canvas");


			var subContainer=document.createElement("table");
			
	
				
			canvas.setAttribute("width", "640");
			canvas.setAttribute("height", "640");
		
			var ctx = canvas.getContext("2d");


			var buttonNext = document.createElement("button");
			buttonNext.innerText="Next";
			buttonNext.setAttribute("class","btn btn-success");

			var buttonPrevious = document.createElement("button");
			buttonPrevious.innerText="Back";
			buttonPrevious.setAttribute("class","btn btn-danger");

			var buttonAutoPlay = document.createElement("button");
			buttonAutoPlay.innerText="Auto";
			buttonAutoPlay.setAttribute("class","btn btn-warning");

			
			var table=document.createElement("table");
			table.setAttribute("width","400px");
			var tr=document.createElement("tr");
			table.appendChild(tr);

			var td1=document.createElement("td");
			td1.appendChild(txtLocation);
			tr.appendChild(td1);

			var td2=document.createElement("td");
			td2.appendChild(txtTurn);
			tr.appendChild(td2);

			var td3=document.createElement("td");
			td3.appendChild(txtCollisions);
			tr.appendChild(td3);

			element.appendChild(header);
			element.appendChild(canvas);
			element.appendChild(table);
			subContainer.appendChild(buttonPrevious);
			subContainer.appendChild(buttonNext);
			subContainer.appendChild(buttonAutoPlay)
		
			element.appendChild(subContainer);
		
		

			var turn = 0;

			var cellSize = Math.min(canvas.width / data[1][0], canvas.height / data[1][1]);


			var dataObject = {}

			dataObject.turn = 0;
			dataObject.selection = [-1, -1];
			dataObject.oppositePlanes=[],
			dataObject.collisionSpot=[-1,-1],
			dataObject.planeData = simulate(data[1][0], data[1][1], data[2]);
			dataObject.ctx = ctx;
			dataObject.canvas = canvas;
			dataObject.width = data[1][0];
			dataObject.height = data[1][1];
			dataObject.txtCollisions = txtCollisions;
			dataObject.txtLocation = txtLocation;
			dataObject.txtTurn = txtTurn;
			dataObject.cellSize = cellSize;
			dataObject.autoPlayButton=buttonAutoPlay;


			canvas.addEventListener('mouseleave', e => {
				dataObject.selection=[-1,-1];
				dataObject.oppositePlanes=[];
				dataObject.collisionSpot=[-1,-1];
				window.requestAnimationFrame(function () { draw(dataObject); });
			});

			canvas.addEventListener('mousemove', e => {
				var newX = Math.floor(e.offsetX / cellSize);
				var newY = Math.floor(e.offsetY / cellSize);
				txtLocation.innerText = "X:" + newX + " " + "Y:" + newY;
				if (newX != dataObject.selection[0] || newY != dataObject.selection[1]) {
					dataObject.selection = [newX, newY];


					var oppositePlanes=[];
					var collisionSpot=[-1,-1];
					
					var currentPlanes=dataObject.planeData[dataObject.turn][1];
					var selectedPlane=_.find(currentPlanes, function(plane1)
					{
						return plane1[0]==newX && plane1[1]==newY;
					});

					if(selectedPlane != undefined)
					{
						dataObject.planeData.forEach(frame => {

						   var collisionData=_.find(frame[1],function(framePlane)
							{
								return framePlane[2]=="X" && _.some(framePlane[4],function(collisionPlane){
									return collisionPlane[4]==selectedPlane[4]
								});
							});
							if(collisionData != undefined)
							{
								collisionSpot=[collisionData[0],collisionData[1]];
								var collidedPlanes=_.map(collisionData[4],function(plane1)
								{
									return plane1[4];
								});
								oppositePlanes=_.filter(currentPlanes,function(plane1)
								{
									return _.includes(collidedPlanes,plane1[4]);
								});
							}
						});


					}

					


				
				dataObject.collisionSpot=collisionSpot;
				dataObject.oppositePlanes=oppositePlanes;


				


				window.requestAnimationFrame(function () { draw(dataObject); });
				}

			});


			buttonNext.addEventListener("click",function()
			{
				nextFrame(dataObject,1);
			});

			buttonPrevious.addEventListener("click",function()
			{
				nextFrame(dataObject,-1);
			});

			buttonAutoPlay.addEventListener("click",function()
			{
				dataObject.turn=0;
				buttonAutoPlay.disabled=true;


				autoPlay(dataObject);
			});



		
			window.requestAnimationFrame(function () { draw(dataObject); });

			
		}



		window.onload = function () {

			cases=[
				["One collision ",[5,5],[[2,1,'v'],[1,2,'>']]],
			    ["Close encounter",[8,8],[[3,1,'v'],[2,3,'>']]],
				["Catastrophy",[6,6],[[1,0,'v'],[3,0,'v'],[5,0,'v'],[0,1,'>'],[2,1,'>'],[4,1,'>'],[1,2,'v'],[3,2,'v'],[5,2,'v'],[0,3,'>'],[2,3,'>'],[4,3,'>'],[1,4,'v'],[3,4,'v'],[5,4,'v'],[0,5,'>'],[2,5,'>'],[4,5,'>']]],	
				["Chained reaction",[9,9],[[4,0,'v'],[4,1,'v'],[4,2,'v'],[1,3,'v'],[4,3,'v'],[0,4,'>'],[1,4,'>'],[2,4,'>'],[3,4,'>']]],
				["Left and Up",[10,10],[[8,2,'<'],[7,3,'^'],[8,3,'<'],[4,4,'<'],[3,5,'^'],[4,5,'<'],[7,5,'^'],[1,7,'^'],[2,8,'<'],[7,8,'<'],[6,9,'^']]],
				["All directions",[8,6],[[4,1,'v'],[2,2,'>'],[6,2,'<'],[4,3,'^']]],
				["4-in-one",[6,6],[[2,1,'v'],[1,2,'>'],[3,2,'<'],[2,3,'^']]],
				["Crowded airspace",[15,15],[[1,0,'v'],[2,0,'>'],[3,0,'v'],[4,0,'v'],[5,0,'>'],[6,0,'v'],[7,0,'>'],[8,0,'v'],[9,0,'v'],[11,0,'>'],[12,0,'v'],[0,1,'v'],[1,1,'>'],[3,1,'>'],[5,1,'>'],[6,1,'v'],[9,1,'>'],[10,1,'>'],[11,1,'v'],[12,1,'v'],[1,2,'v'],[2,2,'>'],[4,2,'>'],[5,2,'v'],[7,2,'v'],[8,2,'>'],[10,2,'>'],[11,2,'>'],[12,2,'v'],[13,2,'v'],[0,3,'>'],[1,3,'v'],[2,3,'>'],[4,3,'v'],[5,3,'v'],[8,3,'v'],[10,3,'>'],[12,3,'v'],[14,3,'>'],[0,4,'>'],[2,4,'v'],[3,4,'v'],[4,4,'>'],[7,4,'v'],[9,4,'>'],[10,4,'>'],[12,4,'v'],[13,4,'>'],[14,4,'>'],[2,5,'v'],[3,5,'>'],[4,5,'>'],[6,5,'v'],[8,5,'>'],[10,5,'v'],[11,5,'>'],[12,5,'>'],[14,5,'>'],[0,6,'v'],[1,6,'>'],[2,6,'>'],[4,6,'>'],[5,6,'>'],[7,6,'>'],[10,6,'v'],[11,6,'v'],[12,6,'>'],[13,6,'>'],[0,7,'>'],[1,7,'>'],[2,7,'v'],[3,7,'>'],[5,7,'>'],[7,7,'>'],[8,7,'>'],[9,7,'v'],[10,7,'v'],[11,7,'>'],[12,7,'>'],[13,7,'>'],[1,8,'>'],[3,8,'>'],[4,8,'v'],[5,8,'v'],[6,8,'>'],[7,8,'v'],[8,8,'v'],[9,8,'>'],[10,8,'v'],[11,8,'v'],[12,8,'>'],[14,8,'v'],[1,9,'>'],[2,9,'v'],[3,9,'v'],[4,9,'>'],[7,9,'>'],[8,9,'v'],[11,9,'v'],[12,9,'v'],[14,9,'v'],[1,10,'v'],[2,10,'>'],[4,10,'>'],[5,10,'v'],[6,10,'v'],[11,10,'v'],[13,10,'v'],[14,10,'v'],[0,11,'v'],[3,11,'>'],[4,11,'>'],[5,11,'>'],[6,11,'v'],[7,11,'>'],[8,11,'>'],[9,11,'v'],[11,11,'v'],[12,11,'v'],[13,11,'v'],[14,11,'v'],[0,12,'v'],[1,12,'>'],[2,12,'>'],[3,12,'v'],[5,12,'>'],[6,12,'v'],[7,12,'v'],[8,12,'>'],[11,12,'>'],[12,12,'>'],[13,12,'>'],[0,13,'v'],[1,13,'v'],[2,13,'v'],[3,13,'v'],[6,13,'>'],[7,13,'v'],[8,13,'v'],[9,13,'v'],[10,13,'v'],[11,13,'>'],[12,13,'>'],[13,13,'v'],[0,14,'v'],[1,14,'>'],[2,14,'v'],[4,14,'>'],[5,14,'v'],[6,14,'v'],[7,14,'>'],[8,14,'>'],[9,14,'v'],[10,14,'>'],[11,14,'v'],[13,14,'v'],[14,14,'>']]],
				["Tiny Space",[1,1],[[0,0,'>']]],
				["Large space",[30,25],[[10,0,'v'],[12,0,'>'],[18,0,'v'],[24,0,'>'],[4,1,'v'],[9,1,'>'],[12,1,'v'],[13,1,'>'],[6,2,'v'],[12,2,'>'],[29,2,'v'],[7,3,'>'],[12,3,'v'],[25,3,'v'],[1,4,'v'],[4,4,'>'],[23,4,'v'],[17,5,'v'],[25,5,'v'],[9,6,'v'],[10,6,'v'],[25,6,'>'],[25,7,'>'],[25,8,'v'],[26,9,'>'],[3,10,'v'],[25,10,'v'],[28,10,'v'],[13,11,'>'],[23,11,'v'],[24,11,'>'],[11,14,'>'],[12,14,'>'],[22,14,'v'],[24,14,'v'],[17,15,'>'],[18,15,'>'],[27,15,'v'],[9,16,'v'],[24,16,'>'],[28,16,'v'],[1,17,'v'],[23,17,'v'],[29,17,'>'],[12,18,'v'],[14,18,'v'],[18,18,'>'],[1,19,'v'],[5,19,'v'],[18,19,'v'],[19,19,'v'],[1,21,'>'],[3,21,'>'],[7,21,'>'],[28,21,'v'],[6,22,'v'],[12,22,'>'],[17,22,'v'],[5,23,'v'],[6,23,'>'],[9,23,'>'],[16,23,'>'],[1,24,'v'],[2,24,'>'],[6,24,'v'],[8,24,'>'],[22,24,'>']]],
				["Final test",[13,13],[[0,0,'^'],[1,0,'>'],[2,0,'>'],[3,0,'^'],[4,0,'>'],[5,0,'<'],[7,0,'v'],[8,0,'^'],[11,0,'>'],[0,1,'v'],[1,1,'<'],[2,1,'v'],[3,1,'v'],[4,1,'^'],[5,1,'<'],[7,1,'v'],[8,1,'^'],[11,1,'v'],[0,2,'>'],[2,2,'>'],[3,2,'v'],[4,2,'v'],[5,2,'^'],[6,2,'<'],[7,2,'v'],[8,2,'>'],[9,2,'v'],[10,2,'^'],[12,2,'^'],[0,3,'v'],[1,3,'>'],[2,3,'<'],[3,3,'v'],[4,3,'>'],[6,3,'<'],[7,3,'>'],[8,3,'v'],[9,3,'>'],[10,3,'<'],[11,3,'>'],[12,3,'<'],[1,4,'<'],[2,4,'v'],[3,4,'v'],[5,4,'v'],[6,4,'v'],[8,4,'v'],[9,4,'v'],[10,4,'<'],[11,4,'>'],[12,4,'^'],[0,5,'^'],[1,5,'v'],[2,5,'^'],[3,5,'^'],[4,5,'^'],[5,5,'v'],[6,5,'^'],[7,5,'>'],[9,5,'^'],[10,5,'v'],[11,5,'<'],[12,5,'<'],[2,6,'>'],[3,6,'>'],[4,6,'<'],[6,6,'^'],[8,6,'>'],[9,6,'^'],[10,6,'^'],[11,6,'<'],[12,6,'v'],[1,7,'>'],[2,7,'<'],[4,7,'v'],[5,7,'<'],[6,7,'>'],[8,7,'v'],[9,7,'>'],[10,7,'^'],[11,7,'<'],[1,8,'>'],[2,8,'>'],[3,8,'<'],[5,8,'v'],[6,8,'v'],[7,8,'<'],[8,8,'<'],[9,8,'^'],[10,8,'^'],[11,8,'<'],[0,9,'>'],[1,9,'v'],[4,9,'v'],[5,9,'<'],[6,9,'^'],[8,9,'v'],[9,9,'<'],[11,9,'v'],[12,9,'>'],[0,10,'v'],[1,10,'>'],[2,10,'^'],[3,10,'v'],[5,10,'<'],[9,10,'v'],[10,10,'v'],[11,10,'v'],[12,10,'<'],[0,11,'^'],[1,11,'v'],[2,11,'v'],[4,11,'<'],[5,11,'^'],[6,11,'^'],[7,11,'>'],[9,11,'<'],[10,11,'<'],[11,11,'<'],[12,11,'v'],[0,12,'v'],[1,12,'^'],[2,12,'^'],[4,12,'^'],[5,12,'^'],[6,12,'<'],[7,12,'v'],[8,12,'v'],[9,12,'^'],[10,12,'^'],[11,12,'^']]],
		
		];
			var refCounter=0;

			var accordion=document.createElement("div");
			accordion.setAttribute("class","accordion");
			accordion.setAttribute("id","acc1");

			document.getElementById("container").appendChild(accordion);
			
			var counter=0;
			cases.forEach(testCase => {

				var accordionItem=document.createElement("div");
				accordionItem.setAttribute("class","accordion-item");
			
				var accordionHeader=document.createElement("h2");
				accordionHeader.setAttribute("class","accordion-header")
				accordionHeader.setAttribute("id","heading"+counter);
				
			
				var accordionButton=document.createElement("button");
				accordionButton.setAttribute("class","accordion-button collapsed")
				accordionButton.setAttribute("type","button");
				accordionButton.setAttribute("data-bs-toggle","collapse");
				accordionButton.setAttribute("data-bs-target","#collapse"+counter);
				accordionButton.setAttribute("aria-expanded","false");
				accordionButton.setAttribute("aria-controls","collapse"+counter);
				accordionButton.innerText=testCase[0];

				accordionHeader.appendChild(accordionButton);

				var collapse=document.createElement("div");
				collapse.setAttribute("id","collapse"+counter);
				collapse.setAttribute("class","accordion-collapse collapse");
				collapse.setAttribute("aria-labelledby","heading"+counter);
				collapse.setAttribute("data-bs-parent","#acc1");



				var accordionBody=document.createElement("div");
				accordionBody.setAttribute("class","accordion-body");

				collapse.appendChild(accordionBody);

				accordionItem.appendChild(accordionHeader);

				accordionItem.appendChild(collapse);
			
				populate(testCase,accordionBody);

				accordion.appendChild(accordionItem);

				counter++;
			});

	

		};

		function autoPlay(context)
		{
			nextFrame(context,1);
			if(context.turn+1<context.planeData.length)
			{
				window.setTimeout(function(){autoPlay(context);},1000);
			}
			else{
				context.autoPlayButton.disabled=false;
			}
		}


		function nextFrame(context,direction) {

			if(context.turn+direction>=0 && context.turn+direction<context.planeData.length)
			{
				context.turn+=direction;
				window.requestAnimationFrame(function () { draw(context); });
				context.txtTurn.innerText ="Turn: "+ context.turn;

				context.txtCollisions.innerText = "Collisions: "+context.planeData[context.turn][0];
			}

		}

		function simulate(width, height, planes) {

			var counter=0;

			var planesCopy = _.map(planes, function(plane)
			{
					return [plane[0],plane[1],plane[2],"#"+ Math.floor(Math.random()*16777215).toString(16), counter++];
			});

			

			var planesHistory=[];
			var totalCollisions = 0;

			while (planesCopy.length > 0) {


				
				planesHistory.push([totalCollisions, JSON.parse(JSON.stringify(planesCopy))]);

				
				planesCopy.forEach(plane => {
					var d = plane[2];
					if (d == '>')
						plane[0]++;
					if (d == '<')
						plane[0]--;
					if (d == '^')
						plane[1]--;
					if (d == 'v')
						plane[1]++;
				
				});

				planesCopy = planesCopy.filter(plane => plane[2]!="X" && plane[0] >= 0 && plane[0] < width && plane[1] >= 0 && plane[1] < height);

				var collisions = _.groupBy(planesCopy, function (plane) {
					return [plane[0], plane[1]];
				});

				Object.keys(collisions).forEach(coordinates => {

					var planesThere = collisions[coordinates];

					if (planesThere.length > 1) {
						totalCollisions++;
						planesThere.forEach(plane => {
							_.pull(planesCopy, plane);
						});

						var realCoordinates=coordinates.split(',');

						planesCopy.push([parseInt(realCoordinates[0]),parseInt(realCoordinates[1]),'X',"#FF0000", planesThere]);
					}

				});

				
			}

			return planesHistory;


		}

		function draw(context) {

			context.ctx.clearRect(0, 0, context.canvas.width, context.canvas.height);

			var pW = context.cellSize * 0.8;
			var pH = context.cellSize * 0.8;

			var pOffsetX = context.cellSize / 2 - pW / 2;
			var pOffsetY = context.cellSize / 2 - pH / 2;


			var planeUp = document.getElementById("planeUp");
			var planeLeft = document.getElementById("planeLeft");
			var planeRight = document.getElementById("planeRight");
			var planeDown = document.getElementById("planeDown");



			for (var r = 0; r < context.height; r++) {
				for (var c = 0; c < context.width; c++) {
					if (r == context.selection[1] && c == context.selection[0])
					{
						context.ctx.beginPath();
						context.ctx.fillStyle = "#FF0000";
						context.ctx.fillRect(c * context.cellSize, r * context.cellSize, context.cellSize, context.cellSize);
						context.ctx.stroke();
					}
					else if (r == context.collisionSpot[1] && c == context.collisionSpot[0])
					{
						context.ctx.drawImage(collision,c * context.cellSize + pOffsetX, r * context.cellSize + pOffsetY, pW, pH);
					}
					else
					{
						context.ctx.beginPath();
						context.ctx.rect(c * context.cellSize, r * context.cellSize, context.cellSize, context.cellSize);
						context.ctx.stroke();
					}
					

				}
			}

			context.oppositePlanes.forEach(opposite => {
				context.ctx.beginPath();
				context.ctx.fillStyle = "#FFFF00";
				context.ctx.fillRect(opposite[0] * context.cellSize, opposite[1] * context.cellSize, context.cellSize, context.cellSize);
				context.ctx.stroke();
			});

			context.planeData[context.turn][1].forEach(plane => {  

				bufferCtx.globalCompositeOperation = "source-over";
				context.ctx.fillStyle = "#FFFFFF";
				bufferCtx.clearRect(0,0,128,128);

				if (plane[2] == '^')
					bufferCtx.drawImage(planeUp,0,0, pW, pH);
				if (plane[2] == '<')
					bufferCtx.drawImage(planeLeft,0,0, pW, pH);
				if (plane[2] == '>')
					bufferCtx.drawImage(planeRight,0,0, pW, pH);
				if (plane[2] == 'v')
					bufferCtx.drawImage(planeDown,0,0, pW, pH);
				if (plane[2] == 'X')
					bufferCtx.drawImage(collision,0,0, pW, pH);

				bufferCtx.globalCompositeOperation = "source-in";

				
				bufferCtx.fillStyle = plane[3];
				bufferCtx.fillRect(0,0,pW,pH);


				context.ctx.drawImage(bufferCanvas,0,0,pW,pH, plane[0] * context.cellSize + pOffsetX, plane[1] * context.cellSize + pOffsetY, pW, pH);
							

			});


		}


	</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>

</body>

</html>